name: Build Unsigned Release

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'

jobs:
  build-unsigned:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y zip jq
        npm install -g web-ext

    - name: Extract data from manifest.json
      run: |
        NAME=$(jq -r '.name' src/Gecko/manifest.json | tr ' ' '_')
        VERSION=$(jq -r '.version' src/Gecko/manifest.json)
        ID=$(jq -r '.browser_specific_settings.gecko.id' src/Gecko/manifest.json)
        echo "EXT_NAME=${NAME}" >> $GITHUB_ENV
        echo "EXT_VERSION=${VERSION}" >> $GITHUB_ENV
        echo "EXT_ID=${ID}" >> $GITHUB_ENV

    - name: Prepare artifacts directories
      run: |
        mkdir -p artifacts/unsigned

    - name: Generate tag and release name
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        YEAR=$(date +'%y')
        MONTH=$(date +'%m')
        RELEASE_COUNT=$(curl -s \
          -H "Authorization: Bearer $GH_TOKEN" \
          https://api.github.com/repos/${{ github.repository }}/releases \
          | jq "[.[] | select(.tag_name | startswith(\"${YEAR}${MONTH}\"))] | length + 1")
        TAG="${YEAR}${MONTH}$(printf "%0${#RELEASE_COUNT}d" ${RELEASE_COUNT})"
        RELEASE_NAME="${EXT_VERSION} (${TAG})"
        echo "RELEASE_TAG=${TAG}" >> $GITHUB_ENV
        echo "RELEASE_NAME=${RELEASE_NAME}" >> $GITHUB_ENV

    - name: Build unsigned XPI
      run: |
        web-ext build -s src/Gecko --artifacts-dir ./artifacts
        mv ./artifacts/*.zip ./artifacts/${EXT_NAME}-${EXT_VERSION}-gecko-unsigned.zip
        mv ./artifacts/${EXT_NAME}-${EXT_VERSION}-gecko-unsigned.zip ./artifacts/unsigned/${EXT_NAME}-${EXT_VERSION}-gecko-unsigned.xpi

    - name: Build Chromium unsigned ZIP
      run: |
        (cd src/Chromium && zip -r ../../artifacts/unsigned/${EXT_NAME}-${EXT_VERSION}-chromium-unsigned.zip .)

    - name: Upload unsigned bundle for follow-up workflows
      uses: actions/upload-artifact@v4
      with:
        name: unsigned-output
        path: artifacts/unsigned

    - name: Persist release metadata
      run: |
        printf "EXT_NAME=%s\n" "$EXT_NAME" > release-metadata.env
        {
          printf "EXT_VERSION=%s\n" "$EXT_VERSION"
          printf "EXT_ID=%s\n" "$EXT_ID"
          printf "RELEASE_TAG=%s\n" "$RELEASE_TAG"
          printf "RELEASE_NAME=%s\n" "$RELEASE_NAME"
        } >> release-metadata.env

    - name: Upload release metadata
      uses: actions/upload-artifact@v4
      with:
        name: release-metadata
        path: release-metadata.env

    - name: Create GitHub Release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create "$RELEASE_TAG" \
          ./artifacts/unsigned/${EXT_NAME}-${EXT_VERSION}-gecko-unsigned.xpi \
          ./artifacts/unsigned/${EXT_NAME}-${EXT_VERSION}-chromium-unsigned.zip \
          --title "$RELEASE_NAME" \
          --notes-file ./release-notes.md